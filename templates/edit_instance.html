{% extends "base.html" %}

{% block title %}Edit {{ instance.type|title }} Instance{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Edit {{ instance.type|title }} Instance</h2>
    
    <form id="editInstanceForm" hx-post="/instances/edit/{{ instance.name }}/{{ instance.type }}" hx-target="#main-content">
        <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" name="name" value="{{ instance.name }}" readonly>
        </div>
        
        <div class="mb-3">
            <label for="type" class="form-label">Type</label>
            <input type="text" class="form-control" id="type" name="type" value="{{ instance.type }}" readonly>
        </div>
        
        <div class="mb-3">
            <label for="url" class="form-label">URL</label>
            <div class="input-group">
                <input type="url" class="form-control" id="url" name="url" value="{{ instance.url }}" required>
                <button type="button" class="btn btn-outline-secondary" onclick="testConnection()">Test Connection</button>
            </div>
            <div id="connectionStatus" class="form-text"></div>
        </div>
        
        <div class="mb-3">
            <label for="api_key" class="form-label">API Key</label>
            <input type="password" class="form-control" id="api_key" name="api_key" value="{{ instance.api_key }}" required>
        </div>
        
        <div class="mb-3">
            <label for="root_folder_path" class="form-label">Root Folder Path</label>
            <input type="text" class="form-control" id="root_folder_path" name="root_folder_path" value="{{ instance.root_folder_path }}" required>
        </div>
        
        <div class="mb-3">
            <label for="quality_profile_id" class="form-label">Quality Profile ID</label>
            <input type="number" class="form-control" id="quality_profile_id" name="quality_profile_id" value="{{ instance.quality_profile_id }}" required>
        </div>
        
        {% if instance.type == "sonarr" %}
        <div class="mb-3">
            <label for="language_profile_id" class="form-label">Language Profile ID</label>
            <input type="number" class="form-control" id="language_profile_id" name="language_profile_id" value="{{ instance.language_profile_id }}">
        </div>
        
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="season_folder" name="season_folder" {% if instance.season_folder %}checked{% endif %}>
            <label class="form-check-label" for="season_folder">Create Season Folders</label>
        </div>
        {% endif %}
        
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="search_on_sync" name="search_on_sync" {% if instance.search_on_sync %}checked{% endif %}>
            <label class="form-check-label" for="search_on_sync">Search on Sync</label>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Enabled Events</label>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="event_grab" name="enabled_events" value="Grab" {% if "Grab" in instance.enabled_events %}checked{% endif %}>
                <label class="form-check-label" for="event_grab">Grab</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="event_import" name="enabled_events" value="Import" {% if "Import" in instance.enabled_events %}checked{% endif %}>
                <label class="form-check-label" for="event_import">Import</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="event_rename" name="enabled_events" value="Rename" {% if "Rename" in instance.enabled_events %}checked{% endif %}>
                <label class="form-check-label" for="event_rename">Rename</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="event_delete" name="enabled_events" value="{% if instance.type == 'sonarr' %}SeriesDelete{% else %}MovieDelete{% endif %}" {% if "Delete" in instance.enabled_events %}checked{% endif %}>
                <label class="form-check-label" for="event_delete">Delete</label>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
async function testConnection() {
    const url = document.getElementById('url').value;
    const apiKey = document.getElementById('api_key').value;
    const type = document.getElementById('type').value;
    const statusDiv = document.getElementById('connectionStatus');
    
    if (!url || !apiKey) {
        statusDiv.innerHTML = '<span class="text-danger">Please fill in both URL and API Key</span>';
        return;
    }
    
    statusDiv.innerHTML = '<span class="text-warning">Testing connection...</span>';
    
    try {
        const formData = new FormData();
        formData.append('type', type);
        formData.append('url', url);
        formData.append('api_key', apiKey);
        
        const response = await fetch('/test-connection', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            statusDiv.innerHTML = `<span class="text-success">${result.message}</span>`;
        } else {
            statusDiv.innerHTML = `<span class="text-danger">${result.message}</span>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<span class="text-danger">Connection test failed: ${error.message}</span>`;
    }
}

// Add form validation before submission
document.getElementById('editInstanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const url = document.getElementById('url').value;
    const apiKey = document.getElementById('api_key').value;
    const type = document.getElementById('type').value;
    
    if (!url || !apiKey) {
        alert('Please fill in both URL and API Key');
        return;
    }
    
    // Test connection before submitting
    const formData = new FormData();
    formData.append('type', type);
    formData.append('url', url);
    formData.append('api_key', apiKey);
    
    try {
        const response = await fetch('/test-connection', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // If connection test succeeds, submit the form
            this.submit();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert(`Connection test failed: ${error.message}`);
    }
});
</script>
{% endblock %} 